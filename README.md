# POSTGRES BLUEPRINT
> ***"–≠—Ç–æ –ª–∏—á–Ω–∞—è —à–ø–∞—Ä–≥–∞–ª–∫–∞ —Å —Å—É–±—ä–µ–∫—Ç–∏–≤–Ω—ã–º–∏ –æ—Ü–µ–Ω–∫–∞–º–∏, –∞ –Ω–µ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è"***


## üïµ –°–∏—Å—Ç–µ–º–Ω–∞—è –ê—É–¥–∏—Ç–∞ Postgresql
–ò–ù–°–¢–†–£–ö–¶–ò–Ø –ü–û **schema_audit.sql**




> ### <b style="color:red;"> ‚ò†Ô∏è –í–ê–ñ–ù–û–ï –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï</b>
> <b style="color:#d1001f;"> –≠–¢–û –ò–ù–°–¢–†–£–ú–ï–ù–¢–´ –î–õ–Ø –û–ü–´–¢–ù–´–• –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†–û–í!</b>
>  <hr>
>
> 1. **–í—Å–µ–≥–¥–∞ —Ç–µ—Å—Ç–∏—Ä—É–π –Ω–∞ DEV-–æ–∫—Ä—É–∂–µ–Ω–∏–∏**
> 2. **–ù–µ –∑–∞–ø—É—Å–∫–∞–π –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –±–µ–∑ –ø–æ–Ω–∏–º–∞–Ω–∏—è –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏–π**
> 3. **–ù–µ–∫–æ—Ç–æ—Ä—ã–µ –∫–æ–º–∞–Ω–¥—ã –º–æ–≥—É—Ç –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–∞–∑—É, —É–¥–∞–ª–∏—Ç—å –¥–∞–Ω–Ω—ã–µ, —Å–ª–æ–º–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–∞–±–ª–∏—Ü**
> 4. **–î–µ–ª–∞–π –±—ç–∫–∞–ø—ã –ø–µ—Ä–µ–¥ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–º–∏**
> 5. **–ù–µ –¥–æ–≤–µ—Ä—è–π —ç–∫—Å–ø–µ—Ä—Ç–∏–∑–µ –ø–µ—Ä–≤–æ–≥–æ –≤—Å—Ç—Ä–µ—á–Ω–æ–≥–æ, –¥—É–º–∞–π —Å–∞–º**
>
> <i style="color:#ffcdbd;">–ê–≤—Ç–æ—Ä –Ω–µ –Ω–µ—Å–µ—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –∑–∞ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —ç—Ç–∏—Ö —Å–∫—Ä–∏–ø—Ç–æ–≤.</i>


*"–ö–æ–¥ –ø–∏—Å–∞–ª—Å—è –≤ —É—Å–ª–æ–≤–∏—è—Ö –≤—ã—Å–æ–∫–∏—Ö –Ω–∞–≥—Ä—É–∑–æ–∫ –∏ —Å—Ä–æ—á–Ω—ã—Ö –∑–∞–¥–∞—á, –ø–æ—ç—Ç–æ–º—É –≤ –Ω—ë–º –º–æ–≥—É—Ç –≤—Å—Ç—Ä–µ—á–∞—Ç—å—Å—è –Ω–µ–∏–¥–µ–∞–ª—å–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è, –Ω–æ –æ–Ω —Å—Ç–∞–±–∏–ª—å–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –∫–ª—é—á–µ–≤—ã–µ –∑–∞–¥–∞—á–∏ –∞—É–¥–∏—Ç–∞"*

<hr> 

–í –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö –ø—Ä–∞–≤–∫–∞—Ö –ø–ª–∞–Ω–∏—Ä—É—é –∏—Å–ø—Ä–∞–≤–∏—Ç—å:
  - —á—Ä–µ–∑–º–µ—Ä–Ω–∞—è –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ—Å—Ç—å –∞—É–¥–∏—Ç–∞ –æ–ø–∞—Å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
  - –¥–æ–±–∞–≤–ª–µ–Ω–∞ –±—É–¥–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–∞—Ü–∏—è –¥–ª—è —ç—Ç–æ–π –∂–µ —Ñ—É–Ω–∫—Ü–∏–∏ (–∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ –Ω–∞ autokill –∑–∞–ø—Ä–æ—Å–æ–≤)
  - –≤–æ–∑–º–æ–∂–Ω–æ –±—É–¥–µ—Ç —É–ø—Ä–æ—â–µ–Ω–∞ —Å—Ö–µ–º–∞
  - –¥–ª—è ddl –∞—É–¥–∏—Ç–∞ —è –æ—á–µ–Ω—å –¥–∞–≤–Ω–æ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–ª –¥–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏—é (–§–£–ù–ö–¶–ò–Ø,–ü–†–û–¶–ï–î–£–†–ê, –¢–ê–ë–õ–ò–¶–ê, –í–¨–Æ–•–ê) - —ç—Ç–æ –Ω–µ —Å–ª–æ–∂–Ω–æ, –¥–∞–∂–µ —Ç—Ä–∏–≥–≥–µ—Ä –Ω–∞ –∞–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å., –Ω–æ –ø–æ–∫–∞ –Ω–µ –¥–æ—Ö–æ–¥—è—Ç —Ä—É–∫–∏

–ò—Å–ø—Ä–∞–≤–∏–ª:
  - –∏—Å–ø—Ä–∞–≤–∏–ª **GRANT ALL ON FUNCTION \*\*\*\* TO  public** 

–¢–†–ï–ë–û–í–ê–ù–ò–Ø:
  - pg_cron (–∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä—É–π –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—é)
  - uuid-ossp (–¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ UUID –≤–º–µ—Å—Ç–æ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π)
  - plpython3u (–≤ —Å—Ö–µ–º–µ —ç—Ç–æ–≥–æ –Ω–µ—Ç, –Ω–æ –ø–æ–≤–µ—Ä—å –æ–Ω –Ω—É–∂–µ–Ω, –≤ –∞–¥–µ–∫–≤–∞—Ç–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–∞—Ö –ø—Ä–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –Ω—É–∂–µ–Ω)

## üõ†Ô∏è –®–ê–ë–õ–û–ù–´ –ó–ê–ü–†–û–°–û–í (–ú–û–ù–ò–¢–û–†–ò–ù–ì, –≠–ö–°–ü–†–ï–°–° –ò–ó–ú–ï–ù–ï–ù–ò–ï –ö–û–ù–§–ò–ì–û–í –∏ —Ç.–¥.)

–î–∞–Ω–Ω—ã–π —Ñ–∞–π–ª —Ö—Ä–∞–Ω–∏—Ç –∑–∞–≥–æ—Ç–æ–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ **(—Ö–æ—Ç—è –Ω–µ –≤—Å–µ–≥–¥–∞ –±—ã—Å—Ç—Ä–æ–≥–æ)** –∑–¥–µ—Å—å –º–æ–∂–Ω–æ –±—ã—Å—Ç—Ä–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏, –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –±–∞–∑—ã, –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã, –µ—Å—Ç—å –ø—Ä–∏–º–µ—Ä —Å–æ —Å–≤—è–∑–∫–æ–π –∏–∑ –∞—É–¥–∏—Ç–∞


## üëÅÔ∏è –®–ü–ê–†–ì–ê–õ–ö–ê –ü–û –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–ò POSTGRESQL

### –ê–ù–ê–õ–ò–¢–ò–ö–ê

##### EXPLAIN
**—ç—Ç–æ –ª–µ–≥–∫–æ–≤–µ—Å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –∞–Ω–∞–ª–∏–∑–∞ –∑–∞–ø—Ä–æ—Å–∞ (–±–µ–∑ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏–π)**
–†–µ–∑—É–ª—å—Ç–∞—Ç: –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º—ã–µ —Å—Ç–æ–∏–º–æ—Å—Ç–∏, –ø–æ—Ä—è–¥–æ–∫ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è (Seq Scan, Index Scan –∏ —Ç.–¥.) [–ù–ï –¢–û–ß–ù–û - –ù–û –ë–´–°–¢–†–û, –î–û –ú–ì–ù–û–í–ï–ù–ò–Ø]

##### EXPLAIN ANALYZE
**–î–∞–Ω–Ω—ã–π –ø–ª–∞–Ω –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∫–∞–∫ –∏ –∑–∞–ø—Ä–æ—Å (–ø–ª–∞–Ω + –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ)**

–†–µ–∑—É–ª—å—Ç–∞—Ç: –î–æ–±–∞–≤–ª—è–µ—Ç —Ä–µ–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ü–∏–∫–ª–æ–≤.
##### EXPLAIN (ANALYZE, TIMING OFF)
**–í—ã–ø–æ–ª–Ω—è–µ—Ç –∑–∞–ø—Ä–æ—Å, –Ω–æ –Ω–µ –∑–∞–º–µ—Ä—è–µ—Ç —Ç–æ—á–Ω–æ–µ –≤—Ä–µ–º—è –Ω–∞ –∫–∞–∂–¥–æ–º —É–∑–ª–µ (–±—ã—Å—Ç—Ä–µ–µ).**

##### EXPLAIN (ANALYZE, BUFFERS)
**–î–∞–Ω–Ω—ã–π –ø–ª–∞–Ω –∏–¥–µ–∞–ª—å–Ω—ã–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ I/O**
–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç:
 - Shared Hit ‚Äì –¥–∞–Ω–Ω—ã–µ –∏–∑ –∫—ç—à–∞
 - Shared Read ‚Äì —á—Ç–µ–Ω–∏–µ —Å –¥–∏—Å–∫–∞
 - temp read/write ‚Äì –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

##### EXPLAIN (ANALYZE, VERBOSE)
**–¥–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (–¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ —Å –¥–∂–æ–π–Ω–∞–º–∏)**
- –ò–º–µ–Ω–∞ —Å—Ç–æ–ª–±—Ü–æ–≤ –≤ –≤—ã–≤–æ–¥–µ
- –ê–ª–∏–∞—Å—ã —Ç–∞–±–ª–∏—Ü
- –§–∏–ª—å—Ç—Ä—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —É–∑–ª–∞



### –ò–ù–î–ï–ö–°–´
–ï—Å–ª–∏ —Ç–∞–±–ª–∏—Ü–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —á—Ç–µ–Ω–∏—è —Å–∏–ª—å–Ω–æ —á–∞—â–µ, —á–µ–º –¥–ª—è –∑–∞–ø–∏—Å–∏
—Ç–æ —Ç—ã –º–æ–∂–µ—à—å –æ—Ç–∫–ª—é—á–∏—Ç—å fastupdate (–≤–∫–ª—é—á–µ–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)

[+] –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫ –ø–æ –Ω–æ–≤—ã–º –¥–∞–Ω–Ω—ã–º        [-] –ú–µ–¥–ª–µ–Ω–Ω–µ–µ INSERT (–Ω–∞ 10-30%)
[+] –°—Ç–∞–±–∏–ª—å–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å           [-] –ë–æ–ª—å—à–µ write amplification
[+] –ü—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ                 [-] –ú–æ–∂–µ—Ç —Ç–æ—Ä–º–æ–∑–∏—Ç—å –º–∞—Å—Å–æ–≤—É—é –≤—Å—Ç–∞–≤–∫—É

```sql
CREATE INDEX idx_chat_messages_gin
ON chat_messages USING GIN (metadata)
WITH (fastupdate = off);  -- –ª—É—á—à–µ –æ—Ç–∫–ª—é—á–∞—Ç—å –Ω–∞ –¥–∞–Ω–Ω—ã–µ –∫–æ—Ç–æ—Ä—ã–µ —Ä–µ–¥–∫–æ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è
```

> –ü–†–ò–ú–ï–†–´, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã –∏–∑ (lab_orders, patvisit)


#### –°–æ—Å—Ç–∞–≤–Ω–æ–π –∏–Ω–¥–µ–∫—Å —Å —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–æ–π –ø–æ –¥–∞—Ç–µ
"–∏—Å–ø–æ–ª—å–∑—É–π —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É —Å –¥–∞—Ç–∞–º–∏ —ç—Ç–æ –±–æ–ª—å—à–∞—è —á–∞—Å—Ç—å –≤ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤"

```sql
CREATE INDEX idx_orders_status_date
ON lab_orders (status, created_at DESC);
```


#### –ò–Ω–¥–µ–∫—Å —Å date_trunc (–∞–≥—Ä–µ–≥–∞—Ü–∏—è –ø–æ –¥–Ω—è–º/–º–µ—Å—è—Ü–∞–º)

```sql
CREATE INDEX idx_sales_monthly
ON patvisit ((date_trunc('day', date_in)));
```

#### –ß–∞—Å—Ç–∏—á–Ω—ã–π –∏–Ω–¥–µ–∫—Å –ø–æ –ø–µ—Ä–∏–æ–¥—É

```sql
CREATE INDEX idx_recent_activities
ON patvisit (pat_id, date_in DESC)
WHERE date_in > CURRENT_DATE - INTERVAL '90 days';
```

#### –ò–Ω–¥–µ–∫—Å –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤
```sql
CREATE INDEX idx_periods_dates
ON patvisit (id, date_in, date_out);
```


### –õ–û–ö–ê–õ–¨–ù–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï –°–ò–°–¢–ï–ú–ù–´–• –ö–û–ù–§–ò–ì–û–í

```sql
BEGIN;
  SET LOCAL work_mem = '64MB';  -- –¢–æ–ª—å–∫–æ –≤ —ç—Ç–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏!
  SELECT * from -- –£–ñ–ê–°–¢–ù–ê–Ø –ù–ï–û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø;
COMMIT;
```

**–∏–ª–∏ –±–æ–ª–µ–µ —Ä–∞–¥–∏–∫–∞–ª—å–Ω–æ** (–±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –ø–æ–∫–∞ —Ç–≤–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–µ—Ä–∂–∏—Ç —Å–µ—Å—Å–∏—é –æ—Ç–∫—Ä—ã—Ç–æ–π)
–Ω–∞ –ø—Ä–∏–º–µ—Ä–µ —Å Dbeaver. –¢—ã –æ—Ç–∫—Ä—ã–ª –æ—Ç–¥–µ–ª—å–Ω—É—é –≤–∫–ª–∞–¥–∫—É, –∑–∞–¥–∞–ª –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è —Å–µ—Å—Å–∏–∏
–∏ –¥–ª—è —ç—Ç–æ–π –≤–∫–ª–∞–¥–∫–∏ —Ç—ã –±—É–¥–µ—à—å —Ä–∞–±–æ—Ç–∞—Ç—å —Å —ç—Ç–∏–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏

```sql
SET SESSION work_mem = '128MB';  -- –ù–∞ –≤—Å—ë –≤—Ä–µ–º—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
SELECT –∑–∞–ø—Ä–æ—Å1;
SELECT –∑–∞–ø—Ä–æ—Å2;
```


### –í–†–ï–ú–ï–ù–ù–´–ï –¢–ê–ë–õ–ò–¶–´ (TEMP TABLES)

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
- –†–∞–∑–±–∏–µ–Ω–∏–µ —Å–ª–æ–∂–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ —á–∞—Å—Ç–∏
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- –£–ø—Ä–æ—â–µ–Ω–∏–µ —Å–ª–æ–∂–Ω—ã—Ö JOIN
- –†–∞–±–æ—Ç–∞ —Å –æ–¥–Ω–∏–º –Ω–∞–±–æ—Ä–æ–º –¥–∞–Ω–Ω—ã—Ö –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö

> [!] –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

```sql
-- 1. –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é —Ç–∞–±–ª–∏—Ü—É
CREATE TEMP TABLE temp_user_orders AS
SELECT
    u.id AS user_id,
    u.email,
    u.created_at AS user_created,
    COUNT(o.id) AS total_orders,
    SUM(o.amount) AS total_amount,
    MAX(o.created_at) AS last_order_date
FROM users u
LEFT JOIN orders o ON u.id = o.user_id
WHERE u.created_at > '2026-01-01'
  AND u.is_active = true
GROUP BY u.id, u.email, u.created_at;

-- 2. –°–æ–∑–¥–∞–µ–º –∏–Ω–¥–µ–∫—Å –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ
CREATE INDEX idx_temp_user_orders_amount ON temp_user_orders (total_amount DESC);
CREATE INDEX idx_temp_user_orders_date ON temp_user_orders (last_order_date DESC);
```

**–ø–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—é —Å–µ—Å—Å–∏–∏ –¥–∞–Ω–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ —É–¥–∞–ª–∏—Ç—Å—è –¥–∞–Ω–Ω—ã–µ –æ—Ç—á–∏—Å—Ç—è—Ç—Å—è** –û—á–µ–Ω—å —É–¥–æ–±–Ω–æ, –µ—Å–ª–∏ –∏—Å–ø—Ä–∞–≤–ª—è–µ—à—å —Ñ—É–Ω–∫—Ü–∏—é —Å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ–º –æ–¥–Ω–æ–≥–æ —É—Å–ª–æ–≤–∏—è
—Ç–∞–º –≥–¥–µ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –∏—Ö —Å–≤—è–∑—ã–≤–∞–µ—Ç –¥–µ—Å—è—Ç–∫–∞–º–∏ union all

## –ò–ù–°–¢–†–£–ú–ï–ù–¢–´ –ê–î–ú–ò–ù–ò–°–¢–†–ò–†–û–í–ê–ù–ò–Ø

1) –ê–Ω–∞–ª–∏–∑ —Å–µ—Ç–∏ (iperf3, ping)
*—Å–∞–º—ã–π –±–∞–Ω–∞–ª—å–Ω—ã–π, –Ω–æ –Ω–µ —Å–∞–º—ã–π —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–Ω—ã–π —Å–ª—É—á–∞–π (—Å–∫–æ—Ä–µ–µ –æ—á–µ–Ω—å —á–∞—Å—Ç–Ω—ã–π, –Ω–æ —Å—Ç–æ–ª–∫–Ω—É—Ç—å—Å—è –º–æ–∂–Ω–æ), –µ—Å–ª–∏ –ø–ª–æ—Ö–æ –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞–Ω–∞ –∏–ª–∏ –Ω–∞–≥—Ä—É–∂–µ–Ω–∞ —Å–µ—Ç—å, –ø–µ—Ä–µ–±–∏—Ç—ã–µ –ø—Ä–æ–≤–æ–¥–∞, —Ä–∞–¥–∏–∞—Ü–∏–æ–Ω–Ω—ã–π/—ç–ª–µ–∫—Ç—Ä–æ–º–∞–≥–Ω–∏—Ç–Ω—ã–π/–ø—Ä–æ—á–∏–π —Ñ–æ–Ω (—Ñ–ª—é—Ä–∞, –∫—Ç...) –æ—Å–æ–±–µ–Ω–Ω–æ –±–µ–∑ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø—Ä–æ–≤–æ–¥–æ–≤ –∏ —Ç.–¥.*
```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ (–ø—Ä–æ–≥—Ä–∞–º–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Ä–µ–∂–∏–º–µ Server listening)
iperf3 -s

# –ù–∞ –ª—é–±–æ–º –∫–ª–∏–µ–Ω—Ç–µ (–≥–¥–µ –ø—Ä–æ–∏—Å—Ö–æ–¥—è—Ç –≤—ã–ª–µ—Ç—ã –±–∞–∑—ã)
iperf3 -c $SERVER_IP -t 10
```
2) –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∂–µ–ª–µ–∑–∞, —Ä–µ—Å—É—Ä—Å–æ–≤ **–æ–±—â–∏–π**  (htop, bpytop,  *konsole+zsh* - –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ –∏ –ø—Ä–∏–≤—ã—á–Ω–µ–π, mc)
*–û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —á–∞—Å—Ç—ã–π —Å–ª—É—á–∞–π - —ç—Ç–æ –Ω–µ—Ö–≤–∞—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤:*
  - *(A) –ü—Ä–æ–∂–æ—Ä–ª–∏–≤—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, –∏ —Ç—ã –º–æ–∂–µ—à—å –¥–∞–∂–µ –Ω–µ –ø–æ–Ω—è—Ç—å —á–µ—Ä–µ–∑ —ç—Ç–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã [–ü–û–°–¢–û–Ø–ù–ù–û]*
  - *(–ë) –ù–µ—É–¥–∞—á–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–Ω—Ñ–∏–≥–∞ [–†–ï–ñ–ï] (–∫–æ–Ω—Ñ–∏–≥ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∂–µ–ª–µ–∑–∞ –∏ –ø–µ—Ä–≤–∏—á–Ω–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏)*
  - *(C) –î–µ–≥—Ä–∞–¥–∞—Ü–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è [–ü–û–ß–¢–ò_–ú–ò–°–¢–ò–ö–ê], –Ω–æ –ø–æ –æ–ø—ã—Ç—É –∫–æ–ª–ª–µ–≥ –±—ã–≤–∞–µ—Ç –∏ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è —Ñ–∞—Ç–∞–ª—å–Ω—ã! –û–±—ã—á–Ω–æ —ç—Ç–æ –ø–æ–ª–Ω—ã–π –æ—Ç–∫–∞–∑ –æ—Å–æ–±–µ–Ω–Ω–æ –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –Ω–µ –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–æ–≤–∞–Ω*
  - *(D) –ö–æ–Ω—Ñ–ª–∏–∫—Ç —Å –¥—Ä—É–≥–∏–º–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è–º–∏! [–ù–£_–°–ö–û–†–ï–ï_–ß–ê–©–ï_–ß–ï–ú_–†–ï–ñ–ï] –µ—Å—Ç—å —Ä—è–¥ —ç–∫—Å–ø–µ—Ä—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –ª—é–±–∏—Ç –∏–ª–∏ –Ω–µ —É–º–µ–µ—Ç Docker, —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ, –Ω–æ –≤ —É—Å–ª–æ–≤–∏—è—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ—Å—É—Ä—Å–æ–≤ –ø–æ—Å—Ç–æ—è–Ω–Ω—ã—Ö –¥–µ–¥–ª–∞–π–Ω–æ–≤ –≤–æ–∑–Ω–∏–∫–∞—é—Ç –ø—Ä–æ–±–ª–µ–º—ã. "–ù—É–∂–Ω–æ —Å—Ä–æ—á–Ω–æ –ø–æ–¥–Ω—è—Ç—å –µ—â—ë –æ–¥–∏–Ω —Å–µ—Ä–≤–∏—Å, –¥–∞–≤–∞–π—Ç–µ –ø–æ–¥–Ω–∏–º–µ–º –µ–≥–æ —Ä—è–¥–æ–º —Å –±–∞–∑–æ–π, –ø–æ—Ç–æ–º –ø–µ—Ä–µ–Ω–µ—Å—ë–º"* 

```bash
# –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Å—Å–∏–π –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
watch -n 2 "psql -c \"SELECT pid, usename, query, state, now() - query_start as duration FROM pg_stat_activity WHERE state != 'idle' ORDER BY duration DESC;\""

# –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫
watch -n 2 "psql -c \"SELECT blocked_locks.pid AS blocked_pid, blocking_locks.pid AS blocking_pid FROM pg_locks blocked_locks JOIN pg_locks blocking_locks ON blocking_locks.locktype = blocked_locks.locktype AND blocking_locks.DATABASE IS NOT DISTINCT FROM blocked_locks.DATABASE AND blocking_locks.relation IS NOT DISTINCT FROM blocked_locks.relation AND blocking_locks.page IS NOT DISTINCT FROM blocked_locks.page AND blocking_locks.tuple IS NOT DISTINCT FROM blocked_locks.tuple AND blocking_locks.virtualxid IS NOT DISTINCT FROM blocked_locks.virtualxid AND blocking_locks.transactionid IS NOT DISTINCT FROM blocked_locks.transactionid AND blocking_locks.classid IS NOT DISTINCT FROM blocked_locks.classid AND blocking_locks.objid IS NOT DISTINCT FROM blocked_locks.objid AND blocking_locks.objsubid IS NOT DISTINCT FROM blocked_locks.objsubid AND blocking_locks.pid != blocked_locks.pid WHERE NOT blocked_locks.granted;\""

htop -u postgres 
bpytop --preset minimal  
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞–º—è—Ç–∏:
free -h                   # –æ–±—â–∞—è –ø–∞–º—è—Ç—å
cat /proc/meminfo | grep -E "(MemFree|Cached|SwapCached)"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ CPU:
mpstat -P ALL 1 5         # –∑–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö —è–¥–µ—Ä
```

4) –ê–Ω–∞–ª–∏–∑ –¥–∏—Å–∫–æ–≤ (ncdu/du-dust, iostat, iotop)
*–ë–ª–∏–Ω, –Ω—É —ç—Ç–æ —Ç–æ–∂–µ **–∫–ª–∞—Å—Å–∏–∫–∞** –ø–µ—Ä–µ—Å—Ç–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –Ω–∞ —Å–∞–π—Ç–µ, –ø–æ—Ç–æ–º—É —á—Ç–æ —Å–∏—Å—Ç–µ–º–∞ –Ω–µ –º–æ–∂–µ—Ç —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–µ—Å—Å–∏—é –Ω–∞ —Å–≤–æ–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ; —Å–∏—Å—Ç–µ–º–∞ –∞–¥–æ–≤–æ –ª–∞–≥–∞–µ—Ç –∏ —Ç–æ—Ä–º–æ–∑–∏—Ç –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ ssh*
```bash
df -hT --total    # –±–æ–ª–µ–µ –º–µ–Ω–µ–µ –ø–æ–ª–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ –¥–∏—Å–∫–∞–º –¥–æ–±–∞–≤—å –ø–∞—Ä–∞–º–µ—Ç—Ä -a —á—Ç–æ–±—ã —Ç–æ—á–Ω–æ –≤—Å—ë –≤—ã–≤–µ—Å—Ç–∏
lsblk -fmt        # —Ç–æ–∂–µ –≤—ã–≤–æ–¥—è—Ç—Å—è —Ä–∞–∑–¥–µ–ª—ã

du -sh *          # –í—ã–≤–µ—Å—Ç–∏ –∏ —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å –∑–∞–Ω—è—Ç–æ—Å—Ç—å –ø–∞–ø–æ–∫
du -ch *.txt      # –æ—Ü–µ–Ω–∏—Ç—å –ø–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—é —Å–∫–æ–ª—å–∫–æ –∑–∞–Ω—è—Ç–æ –º–µ—Å—Ç–æ –≤ –æ–±—â–µ–º
```

5) –ê–Ω–∞–ª–∏–∑ –∑–∞–ø—Ä–æ—Å–æ–≤ [https://habr.com/ru/companies/jetinfosystems/articles/245507/](ASH Viewer), Dbeaver, Pgadmin
*–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ—Å—Ç–æ—è–Ω–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è! –í –ø—è—Ç–Ω–∏—Ü—É –≤–µ—á–µ—Ä–æ–º –ø—Ä–∏—Ö–æ–¥—è—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è, –º–µ–Ω—è—é—Ç—Å—è –ø–æ–ª–æ–≤–∏–Ω–∞ —Ñ—É–Ω–∫—Ü–∏–π. –£—Ç—Ä–æ, –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫, –Ω–∏—á–µ–≥–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –í–ï–ß–ù–ê–Ø –ö–õ–ê–°–°–ò–ö–ê!*
–†–µ–∫–æ–º–µ–Ω–¥—É—é –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å ASH Viewer (—Å–∞–º –Ω–µ –∑–Ω–∞–ª –ø—Ä–æ —ç—Ç–æ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –≤ –º–æ–º–µ–Ω—Ç –Ω–∞–ø–∏—Å–∞–Ω–∏—è –¥–∞–Ω–Ω–æ–≥–æ README)

```bash
# ASH Viewer ‚Äî –∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –æ—Ç Postgres Pro.
# –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã:
# 1. pg_activity (–∫–æ–Ω—Å–æ–ª—å–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥):
pip install pg_activity
pg_activity -U postgres -h localhost

# 2. pgCenter:
docker run -it --rm -e PGUSER=postgres lesovsky/pgcenter
```

### üìö –û–§–ò–¶–ò–ê–õ–¨–ù–´–ï –†–ï–°–£–†–°–´
- [–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è PostgreSQL](https://www.postgresql.org/docs/)
- [pg_stat_statements](https://www.postgresql.org/docs/current/pgstatstatements.html)
- [EXPLAIN](https://www.postgresql.org/docs/current/using-explain.html)